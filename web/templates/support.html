{% extends "base.html" %}
{% block title %}–¢–∏–∫–µ—Ç—ã –ø–æ–¥–¥–µ—Ä–∂–∫–∏ ‚Äî TenderBot Admin{% endblock %}
{% block header_title %}–¢–∏–∫–µ—Ç—ã –ø–æ–¥–¥–µ—Ä–∂–∫–∏{% endblock %}
{% block content %}
<script>
(function(){
    var lastNew = -1;
    function checkNew() {
        fetch('/support/api/new_count', { credentials: 'same-origin' })
            .then(function(r){ return r.json(); })
            .then(function(d){
                var n = d.count || 0;
                if (n > 0) document.title = '[' + n + '] –¢–∏–∫–µ—Ç—ã –ø–æ–¥–¥–µ—Ä–∂–∫–∏ ‚Äî TenderBot Admin';
                else document.title = '–¢–∏–∫–µ—Ç—ã –ø–æ–¥–¥–µ—Ä–∂–∫–∏ ‚Äî TenderBot Admin';
                lastNew = n;
            });
    }
    setInterval(checkNew, 15000);
    setTimeout(checkNew, 2000);
})();
</script>
<div class="page-header">
    <h2 class="page-title">–¢–∏–∫–µ—Ç—ã –ø–æ–¥–¥–µ—Ä–∂–∫–∏</h2>
    <p class="page-subtitle">–ü–µ—Ä–µ–ø–∏—Å–∫–∞ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</p>
</div>
<div class="filters-bar">
    <a href="/support" class="{% if not status_filter %}active{% endif %}">–í—Å–µ</a>
    {% for val, label in statuses %}
    <a href="/support?status={{ val }}" class="{% if status_filter == val %}active{% endif %}">{{ label }}</a>
    {% endfor %}
</div>
<div class="table-wrap">
    <table class="table">
        <thead>
            <tr>
                <th>ID</th>
                <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                <th>Telegram ID</th>
                <th>–°—Ç–∞—Ç—É—Å</th>
                <th>–ü–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</th>
                <th>–î–∞—Ç–∞</th>
                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
        </thead>
        <tbody>
            {% for t in tickets %}
            <tr class="{% if t.status == 'new' %}row-new{% elif t.status == 'in_progress' %}row-in-progress{% endif %}">
                <td>{{ t.id }}</td>
                <td><a href="/support/{{ t.id }}">{{ t.user.full_name }}</a></td>
                <td>{{ t.user.tg_id }}</td>
                <td>
                    {% if t.status == 'new' %}<span class="badge badge-danger">üÜï –ù–æ–≤—ã–π</span>{% endif %}
                    {% if t.status == 'in_progress' %}<span class="badge badge-warning">‚è≥ –í –ø—Ä–æ—Ü–µ—Å—Å–µ</span>{% endif %}
                    {% if t.status == 'closed' %}<span class="badge badge-neutral">üìÅ –ó–∞–∫—Ä—ã—Ç</span>{% endif %}
                </td>
                <td>
                    {% if last_msgs.get(t.id) %}
                    {{ (last_msgs[t.id][0] or '')[:60] }}{% if (last_msgs[t.id][0] or '')|length > 60 %}...{% endif %}
                    {% else %}‚Äî{% endif %}
                </td>
                <td>
                    {% if last_msgs.get(t.id) and last_msgs[t.id][1] %}
                    {{ last_msgs[t.id][1].strftime('%d.%m.%Y %H:%M') }}
                    {% else %}‚Äî{% endif %}
                </td>
                <td>
                    <a href="/support/{{ t.id }}" class="btn btn-primary btn-sm" style="margin-right: 0.25rem;">–û—Ç–∫—Ä—ã—Ç—å</a>
                    <form method="post" action="/support/{{ t.id }}/delete" style="display: inline;" onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å —Ç–∏–∫–µ—Ç –∏ –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è?');">
                        <button type="submit" class="btn btn-danger btn-sm">üóë</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% if not tickets %}
<p class="empty-state">–¢–∏–∫–µ—Ç–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç.</p>
{% endif %}
{% endblock %}
