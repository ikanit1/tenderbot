{% extends "base.html" %}
{% block title %}–¢–∏–∫–µ—Ç—ã –ø–æ–¥–¥–µ—Ä–∂–∫–∏ ‚Äî TenderBot Admin{% endblock %}
{% block content %}
<h1>üí¨ –¢–∏–∫–µ—Ç—ã –ø–æ–¥–¥–µ—Ä–∂–∫–∏</h1>
<script>
(function(){
    var lastNew = -1;
    function checkNew() {
        fetch('/support/api/new_count', { credentials: 'same-origin' })
            .then(function(r){ return r.json(); })
            .then(function(d){
                var n = d.count || 0;
                if (n > 0) document.title = '[' + n + '] –¢–∏–∫–µ—Ç—ã –ø–æ–¥–¥–µ—Ä–∂–∫–∏ ‚Äî TenderBot Admin';
                else document.title = '–¢–∏–∫–µ—Ç—ã –ø–æ–¥–¥–µ—Ä–∂–∫–∏ ‚Äî TenderBot Admin';
                lastNew = n;
            });
    }
    setInterval(checkNew, 15000);
    setTimeout(checkNew, 2000);
})();
</script>
<p>
    <a href="/support">–í—Å–µ</a>
    {% for val, label in statuses %}
    | <a href="/support?status={{ val }}" {% if status_filter == val %}style="font-weight: bold;"{% endif %}>{{ label }}</a>
    {% endfor %}
</p>
<table>
    <tr><th>ID</th><th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th><th>TG ID</th><th>–°—Ç–∞—Ç—É—Å</th><th>–ü–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</th><th>–î–∞—Ç–∞</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr>
    {% for t in tickets %}
    <tr style="{% if t.status == 'new' %}background: #ffebee;{% elif t.status == 'in_progress' %}background: #fff8e1;{% endif %}">
        <td>{{ t.id }}</td>
        <td><a href="/support/{{ t.id }}">{{ t.user.full_name }}</a></td>
        <td>{{ t.user.tg_id }}</td>
        <td>
            {% if t.status == 'new' %}<span style="color: #c62828;">üÜï –ù–æ–≤—ã–π</span>{% endif %}
            {% if t.status == 'in_progress' %}<span style="color: #f9a825;">‚è≥ –í –ø—Ä–æ—Ü–µ—Å—Å–µ</span>{% endif %}
            {% if t.status == 'closed' %}<span style="color: #78909c;">üìÅ –ó–∞–∫—Ä—ã—Ç</span>{% endif %}
        </td>
        <td>
            {% if last_msgs.get(t.id) %}
            {{ (last_msgs[t.id][0] or '')[:60] }}{% if (last_msgs[t.id][0] or '')|length > 60 %}...{% endif %}
            {% else %}‚Äî{% endif %}
        </td>
        <td>
            {% if last_msgs.get(t.id) and last_msgs[t.id][1] %}
            {{ last_msgs[t.id][1].strftime('%d.%m.%Y %H:%M') }}
            {% else %}‚Äî{% endif %}
        </td>
        <td>
            <a href="/support/{{ t.id }}" style="margin-right: 0.5rem;">–û—Ç–∫—Ä—ã—Ç—å</a>
            <form method="post" action="/support/{{ t.id }}/delete" style="display: inline;" onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å —Ç–∏–∫–µ—Ç –∏ –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è?');">
                <button type="submit" style="padding: 0.25rem 0.5rem; background: #6c757d; color: white; border: none; cursor: pointer; border-radius: 3px; font-size: 0.85em;">üóë</button>
            </form>
        </td>
    </tr>
    {% endfor %}
</table>
{% if not tickets %}
<p>–¢–∏–∫–µ—Ç–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç.</p>
{% endif %}
{% endblock %}
