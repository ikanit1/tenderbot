{% extends "base.html" %}
{% block title %}–ß–∞—Ç #{{ ticket.id }} ‚Äî {{ ticket.user.full_name }}{% endblock %}
{% block content %}
<style>
    .chat-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid #dee2e6; }
    .chat-messages { background: #f8f9fa; border-radius: 8px; padding: 1rem; min-height: 300px; max-height: 50vh; overflow-y: auto; margin-bottom: 1rem; }
    .msg { margin-bottom: 0.75rem; padding: 0.5rem 0.75rem; border-radius: 8px; max-width: 85%; }
    .msg.user { background: #e3f2fd; margin-left: 0; margin-right: auto; }
    .msg.admin { background: #e8f5e9; margin-left: auto; margin-right: 0; }
    .msg-meta { font-size: 0.75rem; color: #666; margin-top: 0.25rem; }
    .chat-form { display: flex; gap: 0.5rem; align-items: flex-start; }
    .chat-form textarea { flex: 1; min-height: 60px; padding: 0.5rem; border-radius: 4px; border: 1px solid #ced4da; }
    .chat-form button { padding: 0.5rem 1rem; border-radius: 4px; border: none; cursor: pointer; }
    .templates { margin-top: 0.5rem; }
    .templates button { margin-right: 0.25rem; margin-bottom: 0.25rem; padding: 0.25rem 0.5rem; font-size: 0.875rem; background: #e9ecef; border-radius: 4px; border: 1px solid #dee2e6; cursor: pointer; }
    .templates button:hover { background: #dee2e6; }
</style>
<div class="chat-header">
    <div>
        <a href="/support" style="margin-right: 1rem;">‚Üê –ö —Å–ø–∏—Å–∫—É</a>
        <strong>{{ ticket.user.full_name }}</strong> (TG ID: {{ ticket.user.tg_id }})
        {% if ticket.status == 'new' %}<span style="color: #c62828;">üÜï –ù–æ–≤—ã–π</span>{% endif %}
        {% if ticket.status == 'in_progress' %}<span style="color: #f9a825;">–í –ø—Ä–æ—Ü–µ—Å—Å–µ</span>{% endif %}
        {% if ticket.status == 'closed' %}<span style="color: #78909c;">–ó–∞–∫—Ä—ã—Ç</span>{% endif %}
    </div>
    {% if ticket.status != 'closed' %}
    <form method="post" action="/support/{{ ticket.id }}/close" style="display: inline;">
        <button type="submit" style="background: #6c757d; color: white;">–ó–∞–∫—Ä—ã—Ç—å —Ç–∏–∫–µ—Ç</button>
    </form>
    {% endif %}
</div>

<div class="chat-messages">
    {% for m in messages %}
    <div class="msg {{ m.author }}">
        <div>{{ m.text|e }}</div>
        <div class="msg-meta">{{ m.author }} ¬∑ {{ m.created_at.strftime('%d.%m.%Y %H:%M') if m.created_at else '' }}</div>
    </div>
    {% endfor %}
    {% if not messages %}
    <p style="color: #666;">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π.</p>
    {% endif %}
</div>

{% if ticket.status != 'closed' %}
<form method="post" action="/support/{{ ticket.id }}/reply" class="chat-form">
    <textarea name="text" placeholder="–í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç..." required></textarea>
    <button type="submit" style="background: #28a745; color: white;">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
</form>
<div class="templates">
    <span style="font-size: 0.875rem; color: #666;">–®–∞–±–ª–æ–Ω—ã:</span>
    <button type="button" onclick="document.querySelector('textarea[name=text]').value='–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?'; document.querySelector('textarea[name=text]').focus();">–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ!</button>
    <button type="button" onclick="document.querySelector('textarea[name=text]').value='–í–∞—à –≤–æ–ø—Ä–æ—Å –ø—Ä–∏–Ω—è—Ç –≤ —Ä–∞–±–æ—Ç—É.';">–ü—Ä–∏–Ω—è—Ç –≤ —Ä–∞–±–æ—Ç—É</button>
    <button type="button" onclick="document.querySelector('textarea[name=text]').value='–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–∏–ª–æ–∂–∏—Ç–µ —Å–∫—Ä–∏–Ω—à–æ—Ç –∏–ª–∏ —É—Ç–æ—á–Ω–∏—Ç–µ –¥–µ—Ç–∞–ª–∏.';">–£—Ç–æ—á–Ω–∏—Ç–µ –¥–µ—Ç–∞–ª–∏</button>
    <button type="button" onclick="document.querySelector('textarea[name=text]').value='–°–ø–∞—Å–∏–±–æ –∑–∞ –æ–±—Ä–∞—â–µ–Ω–∏–µ. –¢–∏–∫–µ—Ç –∑–∞–∫—Ä—ã—Ç.';">–ó–∞–∫—Ä—ã—Ç—å —Ç–∏–∫–µ—Ç</button>
</div>
{% endif %}
{% endblock %}
